<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–æ–π —Å NPC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            background: #111;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
            color: white;
            overflow: hidden;
        }
        
        #gameCanvas {
            width: 100%;
            height: 70vh;
            background: #222;
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            width: 100%;
            background: #333;
            flex-wrap: wrap;
        }
        
        .btn {
            width: 80px;
            height: 80px;
            background: #444;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            touch-action: manipulation;
        }
        
        .btn:active {
            background: #666;
        }
        
        .btn.attack {
            background: #c44;
        }
        
        .btn.attack:active {
            background: #e66;
        }
        
        .btn.defend {
            background: #44c;
        }
        
        .btn.defend:active {
            background: #66e;
        }
        
        .info {
            background: #333;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            width: 90%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
        }
        
        .hp-bar {
            width: 100px;
            height: 20px;
            background: #444;
            border-radius: 5px;
            overflow: hidden;
            margin-left: 10px;
        }
        
        .hp-fill {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s;
        }
        
        .npc-hp-fill {
            background: #f44336;
        }
        
        .dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #666;
            display: none;
            z-index: 100;
            width: 90%;
            max-width: 400px;
        }
        
        .dialog-content {
            margin-bottom: 15px;
        }
        
        .close-btn {
            padding: 8px 16px;
            background: #666;
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        .battle-controls {
            display: none;
        }
    </style>
</head>
<body>
    <div class="info">
        <div>–ò–≥—Ä–æ–∫ HP: <span id="playerHP">100</span></div>
        <div class="hp-bar"><div class="hp-fill" id="playerHPBar" style="width: 100%"></div></div>
    </div>
    
    <div class="info">
        <div>NPC HP: <span id="npcHP">100</span></div>
        <div class="hp-bar"><div class="hp-fill npc-hp-fill" id="npcHPBar" style="width: 100%"></div></div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div class="controls" id="moveControls">
        <button class="btn" id="leftBtn">‚Üê</button>
        <button class="btn" id="jumpBtn">‚Üë</button>
        <button class="btn" id="rightBtn">‚Üí</button>
    </div>
    
    <div class="controls battle-controls" id="battleControls">
        <button class="btn attack" id="attackBtn">‚öîÔ∏è –ê—Ç–∞–∫–∞</button>
        <button class="btn defend" id="defendBtn">üõ°Ô∏è –ó–∞—â–∏—Ç–∞</button>
        <button class="btn" id="runBtn">üèÉ –ë–µ–∂–∞—Ç—å</button>
    </div>
    
    <div class="dialog" id="dialog">
        <div class="dialog-content" id="dialogText">–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞...</div>
        <button class="close-btn" id="closeDialog">–î–∞–ª–µ–µ</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –†–∞–∑–º–µ—Ä—ã
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight * 0.7;
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = 'explore'; // explore, dialogue, battle
        
        // –ò–≥—Ä–æ–∫
        const player = {
            x: 100,
            y: 0,
            width: 40,
            height: 60,
            color: '#4CAF50',
            speed: 5,
            velX: 0,
            velY: 0,
            jumpPower: 15,
            grounded: true,
            hp: 100,
            maxHP: 100,
            attack: 20,
            defense: false
        };
        
        // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
        const platform = {
            x: 0,
            y: canvas.height - 100,
            width: canvas.width,
            height: 50,
            color: '#795548'
        };
        
        // NPC
        const npc = {
            x: canvas.width - 150,
            y: 0,
            width: 40,
            height: 60,
            color: '#FF9800',
            hp: 100,
            maxHP: 100,
            attack: 15,
            canTalk: false,
            dialogue: [
                "–•–∞! –¢—ã –æ—Å–º–µ–ª–∏–ª—Å—è –ø–æ–¥–æ–π—Ç–∏ –∫–æ –º–Ω–µ?",
                "–°–µ–π—á–∞—Å —è –Ω–∞—É—á—É —Ç–µ–±—è —É–≤–∞–∂–µ–Ω–∏—é!",
                "–ì–æ—Ç–æ–≤—å—Å—è –∫ –±–æ—é!"
            ],
            currentDialogue: 0
        };
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º
        player.y = platform.y - player.height;
        npc.y = platform.y - npc.height;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const playerHP = document.getElementById('playerHP');
        const playerHPBar = document.getElementById('playerHPBar');
        const npcHP = document.getElementById('npcHP');
        const npcHPBar = document.getElementById('npcHPBar');
        const dialog = document.getElementById('dialog');
        const dialogText = document.getElementById('dialogText');
        const closeDialog = document.getElementById('closeDialog');
        const moveControls = document.getElementById('moveControls');
        const battleControls = document.getElementById('battleControls');
        
        // –ö–Ω–æ–ø–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');
        
        // –ö–Ω–æ–ø–∫–∏ –±–æ—è
        const attackBtn = document.getElementById('attackBtn');
        const defendBtn = document.getElementById('defendBtn');
        const runBtn = document.getElementById('runBtn');
        
        let leftPressed = false;
        let rightPressed = false;
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'explore') leftPressed = true;
        });
        leftBtn.addEventListener('touchend', () => leftPressed = false);
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'explore') rightPressed = true;
        });
        rightBtn.addEventListener('touchend', () => rightPressed = false);
        
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'explore' && player.grounded) {
                player.velY = -player.jumpPower;
                player.grounded = false;
            }
        });
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–µ–º
        attackBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'battle') playerAttack();
        });
        
        defendBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'battle') {
                player.defense = true;
                setTimeout(() => player.defense = false, 1000);
                npcAttack();
            }
        });
        
        runBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'battle') {
                endBattle();
            }
        });
        
        // –î–∏–∞–ª–æ–≥
        closeDialog.addEventListener('click', () => {
            if (npc.currentDialogue < npc.dialogue.length - 1) {
                npc.currentDialogue++;
                showDialog(npc.dialogue[npc.currentDialogue]);
            } else {
                dialog.style.display = 'none';
                startBattle();
            }
        });
        
        // –§–∏–∑–∏–∫–∞
        const gravity = 0.8;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        function update() {
            if (gameState !== 'explore') return;
            
            // –î–≤–∏–∂–µ–Ω–∏–µ
            player.velX = 0;
            if (leftPressed) player.velX = -player.speed;
            if (rightPressed) player.velX = player.speed;
            
            // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
            player.velY += gravity;
            
            // –ü–æ–∑–∏—Ü–∏—è
            player.x += player.velX;
            player.y += player.velY;
            
            // –ì—Ä–∞–Ω–∏—Ü—ã
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) {
                player.x = canvas.width - player.width;
            }
            
            // –ï—Å–ª–∏ —É–ø–∞–ª
            if (player.y > canvas.height) {
                resetPlayer();
            }
            
            // –ö–æ–ª–ª–∏–∑–∏—è —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π
            player.grounded = false;
            if (player.x < platform.x + platform.width &&
                player.x + player.width > platform.x &&
                player.y < platform.y + platform.height &&
                player.y + player.height > platform.y) {
                
                if (player.velY > 0) {
                    player.y = platform.y - player.height;
                    player.velY = 0;
                    player.grounded = true;
                }
            }
            
            // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å NPC
            const distance = Math.abs(player.x - npc.x);
            npc.canTalk = distance < 100 && player.grounded;
            
            if (npc.canTalk && gameState === 'explore') {
                canvas.addEventListener('touchstart', startDialogue, {once: true});
            }
        }
        
        function startDialogue() {
            gameState = 'dialogue';
            npc.currentDialogue = 0;
            showDialog(npc.dialogue[0]);
        }
        
        function showDialog(text) {
            dialogText.textContent = text;
            dialog.style.display = 'block';
        }
        
        function startBattle() {
            gameState = 'battle';
            moveControls.style.display = 'none';
            battleControls.style.display = 'flex';
        }
        
        function playerAttack() {
            // –ê—Ç–∞–∫–∞ –∏–≥—Ä–æ–∫–∞
            const damage = player.attack;
            npc.hp -= damage;
            if (npc.hp < 0) npc.hp = 0;
            
            updateHPBars();
            
            if (npc.hp <= 0) {
                setTimeout(() => {
                    alert("–í—ã –ø–æ–±–µ–¥–∏–ª–∏ NPC!");
                    endBattle();
                    npc.hp = npc.maxHP; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º NPC
                    updateHPBars();
                }, 300);
                return;
            }
            
            // –û—Ç–≤–µ—Ç–Ω–∞—è –∞—Ç–∞–∫–∞ NPC
            setTimeout(() => npcAttack(), 500);
        }
        
        function npcAttack() {
            if (npc.hp <= 0) return;
            
            let damage = npc.attack;
            if (player.defense) {
                damage = Math.floor(damage / 2);
            }
            
            player.hp -= damage;
            if (player.hp < 0) player.hp = 0;
            
            updateHPBars();
            
            if (player.hp <= 0) {
                setTimeout(() => {
                    alert("–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!");
                    endBattle();
                    player.hp = player.maxHP; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä–æ–∫–∞
                    updateHPBars();
                }, 300);
            }
        }
        
        function updateHPBars() {
            playerHP.textContent = player.hp;
            npcHP.textContent = npc.hp;
            
            const playerHPPercent = (player.hp / player.maxHP) * 100;
            const npcHPPercent = (npc.hp / npc.maxHP) * 100;
            
            playerHPBar.style.width = playerHPPercent + '%';
            npcHPBar.style.width = npcHPPercent + '%';
        }
        
        function endBattle() {
            gameState = 'explore';
            moveControls.style.display = 'flex';
            battleControls.style.display = 'none';
        }
        
        function resetPlayer() {
            player.x = 100;
            player.y = platform.y - player.height;
            player.velX = 0;
            player.velY = 0;
            player.grounded = true;
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
            ctx.fillStyle = platform.color;
            ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            
            // NPC
            ctx.fillStyle = npc.color;
            ctx.fillRect(npc.x, npc.y, npc.width, npc.height);
            
            // HP –Ω–∞–¥ NPC
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText(`${npc.hp}/${npc.maxHP}`, npc.x, npc.y - 10);
            
            // –ò–≥—Ä–æ–∫
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // HP –Ω–∞–¥ –∏–≥—Ä–æ–∫–æ–º
            ctx.fillStyle = 'white';
            ctx.fillText(`${player.hp}/${player.maxHP}`, player.x, player.y - 10);
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            if (npc.canTalk && gameState === 'explore') {
                ctx.fillStyle = '#FFEB3B';
                ctx.font = '16px Arial';
                ctx.fillText('–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞', npc.x - 40, npc.y - 30);
            }
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞—â–∏—Ç—ã
            if (player.defense) {
                ctx.fillStyle = 'rgba(0, 100, 255, 0.5)';
                ctx.fillRect(player.x - 5, player.y - 5, player.width + 10, player.height + 10);
            }
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // –ó–∞–ø—É—Å–∫
        updateHPBars();
        gameLoop();
    </script>
</body>
</html>